name: AI Code Review (Reusable)

# This workflow can be called from other repositories
# Add this to your repository's .github/workflows/ai-review.yml:
#
# name: AI Review
# on:
#   pull_request:
#     types: [opened, synchronize, reopened, ready_for_review]
#
# jobs:
#   review:
#     uses: YOUR_ORG/coding-agents/.github/workflows/ai-review-reusable.yml@main
#     secrets: inherit

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: false
        type: number
      wait_for_ci:
        description: 'Wait for CI checks before reviewing'
        required: false
        type: boolean
        default: true
      ci_check_name:
        description: 'Name of CI check to wait for'
        required: false
        type: string
        default: 'build'
    secrets:
      GITHUB_TOKEN:
        required: true
      LLM_NAME:
        required: false
      URL_LLM:
        required: false
      APIKEY_LLM:
        required: true

jobs:
  ai-review:
    name: AI Code Review
    runs-on: ubuntu-latest

    if: github.event.pull_request.draft == false

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout reviewer agent
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/coding-agents
          path: coding-agents
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd coding-agents
          pip install -e .

      - name: Wait for CI checks
        if: inputs.wait_for_ci
        uses: fountainhead/action-wait-for-check@v1.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: ${{ inputs.ci_check_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 600
          intervalSeconds: 30
        continue-on-error: true

      - name: Run AI Reviewer
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LLM_NAME: ${{ secrets.LLM_NAME }}
          URL_LLM: ${{ secrets.URL_LLM }}
          APIKEY_LLM: ${{ secrets.APIKEY_LLM }}
        run: |
          cd coding-agents
          PR_NUMBER=${{ inputs.pr_number || github.event.pull_request.number }}
          python reviewer_runner.py --repo ${{ github.repository }} --pr $PR_NUMBER
